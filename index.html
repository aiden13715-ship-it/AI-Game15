<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NEON QUICKDRAW: COWBOY VS ROBOT</title>
  <style>
    :root{
      --bg0:#040615;
      --bg1:#070a22;
      --panel: rgba(8, 12, 34, .66);
      --line: rgba(255,255,255,.12);
      --txt: rgba(245,250,255,.95);
      --muted: rgba(245,250,255,.72);

      --cyan:#24f6ff;
      --mag:#b25bff;
      --lime:#7dff9c;
      --amber:#ffd28a;
      --red:#ff6b8a;

      --r: 18px;
      --shadow: 0 18px 60px rgba(0,0,0,.48);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--txt);
      background:
        radial-gradient(900px 520px at 18% 18%, rgba(36,246,255,.14), transparent 60%),
        radial-gradient(900px 520px at 82% 12%, rgba(178,91,255,.12), transparent 60%),
        radial-gradient(900px 560px at 55% 88%, rgba(125,255,156,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Neon grid + scanlines (futuristic, but game is pixel art) */
    .aurora{
      position: fixed; inset:-60px;
      z-index:-4;
      background:
        radial-gradient(720px 280px at 22% 28%, rgba(36,246,255,.20), transparent 60%),
        radial-gradient(680px 260px at 78% 18%, rgba(178,91,255,.16), transparent 60%),
        radial-gradient(680px 260px at 55% 84%, rgba(125,255,156,.12), transparent 60%);
      filter: blur(16px);
      opacity:.85;
      animation: drift 10.5s ease-in-out infinite alternate;
    }
    @keyframes drift{
      0%{ transform: translate3d(-14px,-10px,0) scale(1); }
      100%{ transform: translate3d(14px,12px,0) scale(1.03); }
    }
    .bgGrid{
      position: fixed; inset:0;
      z-index:-3;
      opacity:.20;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.09) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.07) 1px, transparent 1px);
      background-size: 56px 56px;
      mask-image: radial-gradient(circle at 50% 30%, rgba(0,0,0,1), rgba(0,0,0,.0) 70%);
      animation: gridMove 12s linear infinite;
    }
    @keyframes gridMove{
      from{ background-position: 0 0, 0 0; }
      to{ background-position: 0 170px, 170px 0; }
    }
    .scanlines{
      position: fixed; inset:0;
      z-index:-2;
      pointer-events:none;
      background: repeating-linear-gradient(
        to bottom,
        rgba(0,0,0,0) 0px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,.12) 4px
      );
      mix-blend-mode: overlay;
      opacity:.40;
    }

    header{
      position: sticky;
      top:0;
      z-index: 10;
      background: rgba(6,10,34,.55);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding: 16px 14px;
    }
    .wrap{ max-width: 1120px; margin:0 auto; }
    .titleRow{ display:flex; gap: 14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    h1{
      margin:0;
      font-size: 20px;
      letter-spacing:.45px;
      text-transform: uppercase;
    }
    .subtitle{
      margin-top:6px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    /* Pixel-ish heading vibe */
    .pixel{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      letter-spacing: .9px;
      text-shadow:
        0 0 12px rgba(36,246,255,.26),
        0 0 14px rgba(178,91,255,.18);
    }

    main{
      max-width: 1120px;
      margin:0 auto;
      padding: 14px;
      display:grid;
      gap: 12px;
    }
    .grid2{
      display:grid;
      gap: 12px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .grid2{ grid-template-columns: 1.35fr .65fr; }
    }

    .card{
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--r);
      padding: 14px;
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(520px 160px at 18% 10%, rgba(36,246,255,.16), transparent 60%),
        radial-gradient(520px 160px at 82% 0%, rgba(178,91,255,.12), transparent 60%),
        radial-gradient(620px 160px at 50% 100%, rgba(125,255,156,.09), transparent 60%);
      opacity:.9;
      filter: blur(10px);
      pointer-events:none;
    }
    .card > *{ position: relative; }

    .hud{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 0 0 1px rgba(36,246,255,.05) inset;
    }
    .pill strong{ font-weight: 900; letter-spacing:.2px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex:1; min-width: 160px; }

    label{ display:block; font-size:12px; color: var(--muted); margin-bottom: 6px; }

    select, button{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(5, 8, 28, .68);
      color: var(--txt);
      outline: none;
    }
    select{
      width:100%;
      padding: 12px 12px;
    }
    select:focus{
      border-color: rgba(36,246,255,.55);
      box-shadow: 0 0 0 3px rgba(36,246,255,.10);
    }

    button{
      width:100%;
      padding: 12px 12px;
      cursor:pointer;
      font-weight: 950;
      letter-spacing:.35px;
      text-transform: uppercase;
      background: linear-gradient(135deg, rgba(36,246,255,.55), rgba(178,91,255,.50));
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
      position: relative;
      overflow:hidden;
      transition: transform .12s ease, filter .18s ease;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.08); }
    button:active{ transform: translateY(0) scale(.99); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .btnDanger{
      background: linear-gradient(135deg, rgba(255,107,138,.60), rgba(178,91,255,.48));
    }
    .btnGhost{
      background: linear-gradient(135deg, rgba(36,246,255,.25), rgba(255,255,255,.08));
    }

    /* Arena: crisp pixel canvas */
    .arena{
      margin-top: 10px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      box-shadow: 0 0 0 1px rgba(36,246,255,.06) inset;
      overflow:hidden;
    }
    .canvasWrap{
      display:grid;
      place-items:center;
      padding: 12px;
    }
    canvas#game{
      width: 100%;
      max-width: 880px;
      aspect-ratio: 16 / 9;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      image-rendering: pixelated;
    }

    .controls{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .controls > *{ flex:1; min-width: 200px; }

    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      line-height: 1.45;
      max-height: 300px;
      overflow:auto;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }
    .good{ color: var(--lime); }
    .bad{ color: var(--red); }
    .warn{ color: var(--amber); }

    .toast{
      position: fixed;
      left: 50%;
      top: 76px;
      transform: translateX(-50%);
      z-index: 55;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(6,10,34,.65);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      font-size: 13px;
      opacity: 0;
      pointer-events:none;
    }
    .toast.show{ animation: toastPop 1.35s ease-out both; }
    @keyframes toastPop{
      0%{ opacity:0; transform: translateX(-50%) translateY(-6px) scale(.985); }
      16%{ opacity:1; transform: translateX(-50%) translateY(0) scale(1); }
      82%{ opacity:1; }
      100%{ opacity:0; transform: translateX(-50%) translateY(-7px) scale(.99); }
    }

    .intro{
      position: fixed; inset:0;
      z-index: 90;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.52);
      backdrop-filter: blur(12px);
    }
    .introCard{
      width: min(1040px, 100%);
      border-radius: 22px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(6,10,34,.72);
      box-shadow: 0 28px 80px rgba(0,0,0,.55);
      position: relative;
      overflow:hidden;
    }
    .introTitle{
      margin:0 0 6px 0;
      font-size: 20px;
      font-weight: 1000;
      text-transform: uppercase;
      letter-spacing:.6px;
    }
    .introText{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.4;
    }
    .chips{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 12px;
    }
    .chip{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 12px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      margin: 0 2px;
    }
  </style>
</head>

<body>
  <div class="aurora"></div>
  <div class="bgGrid"></div>
  <div class="scanlines"></div>
  <div class="toast" id="toast"></div>

  <div class="intro" id="intro">
    <div class="introCard">
      <div class="row" style="align-items:flex-start;">
        <div style="flex:1.3; min-width:260px;">
          <div class="introTitle pixel">NEON QUICKDRAW: COWBOY VS ROBOT</div>
          <p class="introText">
            Pixel-cinematic duel. Wait for <b>FIRE!</b> then press <span class="kbd">‚Üì</span> (Down Arrow) or <span class="kbd">Space</span>.
            If you press early, it‚Äôs a <b>FALSE START</b> and the robot wins the round.
          </p>
          <div class="chips">
            <span class="chip">üé¨ Pixel cutscenes</span>
            <span class="chip">‚ö° Futuristic neon HUD</span>
            <span class="chip">üß† AI difficulty</span>
            <span class="chip">üéÆ Best-of-9</span>
            <span class="chip">üõ°Ô∏è Anti-cheat</span>
          </div>
          <div class="row" style="margin-top:12px;">
            <button id="bootBtn" style="max-width:260px;">BOOT DUEL</button>
            <div style="color:var(--muted); font-size:12px; align-self:center;">
              Press <span class="kbd">‚Üì</span> to shoot.
            </div>
          </div>
        </div>
        <div style="flex:.7; min-width:240px;">
          <div class="pill"><strong>HOW TO WIN</strong> <span style="opacity:.75;">first to 5 wins</span></div>
          <div class="pill" style="margin-top:10px;"><strong>TIP</strong> Don‚Äôt flinch. Wait for FIRE.</div>
        </div>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap">
      <div class="titleRow">
        <div>
          <h1 class="pixel">NEON QUICKDRAW</h1>
          <div class="subtitle">Cowboy (You) vs Robot (AI) ‚Ä¢ Press <span class="kbd">‚Üì</span> or <span class="kbd">Space</span> to shoot ‚Ä¢ False start loses</div>
          <div class="hud" id="hud"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="grid2">
    <section class="card">
      <div class="row">
        <div>
          <label for="difficulty">AI Difficulty</label>
          <select id="difficulty">
            <option value="easy">Easy (slow robot)</option>
            <option value="normal" selected>Normal</option>
            <option value="hard">Hard (fast robot)</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="startBtn">Start Match</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="restartBtn" class="btnGhost">Restart Match</button>
        </div>
      </div>

      <div class="arena">
        <div class="canvasWrap">
          <canvas id="game" width="320" height="180" aria-label="Pixel duel scene"></canvas>
        </div>
      </div>

      <div class="controls">
        <button id="shootBtn" class="btnDanger">SHOOT (‚Üì / Space)</button>
        <button id="muteBtn" class="btnGhost">Sound: ON</button>
      </div>

      <div class="hud" style="justify-content:center; margin-top:10px;">
        <span class="pill"><strong>Anti-cheat:</strong> shoot early = FALSE START</span>
        <span class="pill"><strong>Cutscene:</strong> shoot ‚Üí muzzle flash ‚Üí hit ‚Üí fall</span>
      </div>
    </section>

    <aside class="card">
      <div class="row" style="align-items:flex-start;">
        <div style="flex:1;">
          <div class="pill"><strong>Score</strong> <span style="opacity:.75;">(Best-of-9)</span></div>
          <div class="row" style="margin-top:10px;">
            <div class="pill"><strong>You:</strong> <span id="scoreYou">0</span></div>
            <div class="pill"><strong>AI:</strong> <span id="scoreAI">0</span></div>
            <div class="pill"><strong>Round:</strong> <span id="roundNum">1/9</span></div>
          </div>

          <div class="pill" style="margin-top:14px;"><strong>Stats</strong> <span style="opacity:.75;">ms</span></div>
          <div class="row" style="margin-top:10px;">
            <div class="pill"><strong>Your Avg:</strong> <span id="avgYou">‚Äî</span></div>
            <div class="pill"><strong>Your Fastest:</strong> <span id="fastYou">‚Äî</span></div>
            <div class="pill"><strong>AI Avg:</strong> <span id="avgAi">‚Äî</span></div>
          </div>
        </div>
      </div>

      <div style="height:12px;"></div>
      <div class="pill"><strong>Game Log</strong> <span style="opacity:.75;">(testing + documentation)</span></div>
      <div class="log" id="log" style="margin-top:10px;"></div>
      <div style="height:12px;"></div>
      <div class="row">
        <button id="copyLogBtn">Copy Log</button>
        <button id="clearLogBtn" class="btnGhost">Clear Log</button>
      </div>
    </aside>
  </main>

<script>
(() => {
  // ---------- DOM ----------
  const $ = (id) => document.getElementById(id);
  const toastEl = $("toast");
  const hudEl = $("hud");
  const logEl = $("log");

  const bootBtn = $("bootBtn");
  const intro = $("intro");
  const startBtn = $("startBtn");
  const restartBtn = $("restartBtn");
  const shootBtn = $("shootBtn");
  const difficultySel = $("difficulty");

  const scoreYouEl = $("scoreYou");
  const scoreAiEl = $("scoreAI");
  const roundNumEl = $("roundNum");
  const avgYouEl = $("avgYou");
  const fastYouEl = $("fastYou");
  const avgAiEl = $("avgAi");

  const copyLogBtn = $("copyLogBtn");
  const clearLogBtn = $("clearLogBtn");
  const muteBtn = $("muteBtn");

  // ---------- Toast + Log ----------
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.remove("show");
    void toastEl.offsetWidth;
    toastEl.classList.add("show");
  }
  function log(msg, cls=""){
    const line = document.createElement("div");
    if(cls) line.className = cls;
    const t = new Date().toLocaleTimeString();
    line.textContent = `[${t}] ${msg}`;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }

  // ---------- Audio (beeps, no external files) ----------
  let audioCtx = null;
  let muted = false;
  function ensureAudio(){
    if (audioCtx) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return;
    audioCtx = new AC();
  }
  function beep(freq=660, durMs=70, type="square", gain=0.05){
    if (muted) return;
    try{
      ensureAudio();
      if(!audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g);
      g.connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime + durMs/1000);
    }catch{}
  }
  muteBtn.addEventListener("click", () => {
    muted = !muted;
    muteBtn.textContent = muted ? "Sound: OFF" : "Sound: ON";
    toast(muted ? "Sound muted." : "Sound enabled.");
  });

  // ---------- Pixel Canvas Setup ----------
  const canvas = $("game");
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;

  // Low-res pixel scene coordinates: 320x180
  const W = canvas.width, H = canvas.height;

  // ---------- Game State ----------
  const state = {
    started: false,
    inRound: false,
    waiting: false,
    fireShown: false,
    locked: false,          // double input prevention
    round: 1,
    maxRounds: 9,
    scoreYou: 0,
    scoreAI: 0,

    fireTime: 0,
    aiReactMs: 0,
    aiTimer: null,
    fireTimer: null,
    countdownTimer: null,

    youTimes: [],
    aiTimes: [],
    youFastest: null,

    // cutscene / animation:
    scene: "idle",          // idle | countdown | wait | fire | you_shoot | ai_shoot | hit | win | lose | match_over
    sceneT: 0,
    message: "BOOT TO BEGIN",
    sub: "Press Start Match when ready.",
    // characters:
    cowboy: { x: 86, y: 98, pose:"idle", hp:1, hit:false, fall:0 },
    robot:  { x: 234, y: 90, pose:"idle", hp:1, hit:false, fall:0 },
    // bullet/tracer:
    tracer: null,           // {x1,y1,x2,y2,t}
    sparks: [],
    confetti: []
  };

  function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

  function clearTimers(){
    if(state.aiTimer){ clearTimeout(state.aiTimer); state.aiTimer=null; }
    if(state.fireTimer){ clearTimeout(state.fireTimer); state.fireTimer=null; }
    if(state.countdownTimer){ clearTimeout(state.countdownTimer); state.countdownTimer=null; }
  }

  function avg(arr){
    if(!arr.length) return null;
    return Math.round(arr.reduce((a,b)=>a+b,0)/arr.length);
  }

  function updateHUD(){
    hudEl.innerHTML = "";
    const pills = [
      `Round: ${state.round}/${state.maxRounds}`,
      `You: ${state.scoreYou}`,
      `AI: ${state.scoreAI}`,
      `Difficulty: ${difficultySel.value.toUpperCase()}`,
      `Shoot: ‚Üì or Space`
    ];
    for(const t of pills){
      const s = document.createElement("span");
      s.className = "pill";
      s.textContent = t;
      hudEl.appendChild(s);
    }

    scoreYouEl.textContent = String(state.scoreYou);
    scoreAiEl.textContent = String(state.scoreAI);
    roundNumEl.textContent = `${state.round}/${state.maxRounds}`;

    const youAvg = avg(state.youTimes);
    const aiAvgV = avg(state.aiTimes);
    avgYouEl.textContent = youAvg === null ? "‚Äî" : String(youAvg);
    avgAiEl.textContent = aiAvgV === null ? "‚Äî" : String(aiAvgV);
    fastYouEl.textContent = state.youFastest === null ? "‚Äî" : String(Math.round(state.youFastest));
  }

  // ---------- AI reaction distribution ----------
  function sampleAiReactionMs(diff){
    let base, spread;
    if(diff === "easy"){ base = 380; spread = 150; }
    else if(diff === "hard"){ base = 220; spread = 95; }
    else { base = 300; spread = 120; }

    // pseudo-normal from sum of uniforms
    let u = 0;
    for(let i=0;i<6;i++) u += Math.random();
    u = (u/6) - 0.5;

    let ms = base + u*spread;
    if(Math.random() < 0.06) ms -= 70;
    if(Math.random() < 0.06) ms += 90;

    ms = clamp(ms, diff==="hard"?150:180, 650);
    return Math.round(ms);
  }

  // ---------- Pixel Drawing Helpers ----------
  function pxFill(x,y,w,h,c){
    ctx.fillStyle = c;
    ctx.fillRect(Math.floor(x), Math.floor(y), Math.floor(w), Math.floor(h));
  }
  function pxText(text, x, y, c="#eaf2ff"){
    ctx.fillStyle = c;
    ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
    ctx.fillText(text, x|0, y|0);
  }

  function drawNeonSky(t){
    // pixel gradient bands
    pxFill(0,0,W,H,"#07081a");
    // horizon glow
    const glow = 0.35 + 0.25*Math.sin(t*0.0012);
    pxFill(0, 88, W, 40, `rgba(36,246,255,${0.06+glow*0.05})`);
    pxFill(0, 96, W, 36, `rgba(178,91,255,${0.05+glow*0.04})`);

    // stars
    for(let i=0;i<28;i++){
      const sx = (i*37 + (t*0.01)) % W;
      const sy = (i*19) % 70;
      pxFill(sx, sy, 1, 1, "rgba(255,255,255,.55)");
    }

    // neon city silhouette (pixel blocks)
    for(let x=0;x<W;x+=8){
      const h = 16 + Math.floor(10*Math.abs(Math.sin((x*0.02)+t*0.0008)));
      pxFill(x, 88-h, 7, h, "rgba(0,0,0,.72)");
      // windows
      if((x/8)%3===0){
        pxFill(x+2, 88-h+4, 1, 1, `rgba(36,246,255,${0.18+0.08*Math.sin(t*0.002 + x)})`);
        pxFill(x+4, 88-h+9, 1, 1, `rgba(178,91,255,${0.14+0.08*Math.sin(t*0.002 + x*0.7)})`);
      }
    }

    // ground
    pxFill(0, 120, W, 60, "rgba(0,0,0,.65)");
    // neon floor grid lines
    const shift = Math.floor((t*0.06)%8);
    for(let y=122;y<H;y+=8){
      const alpha = (y-120)/60;
      pxFill(0, y, W, 1, `rgba(36,246,255,${0.04+alpha*0.08})`);
    }
    for(let x=0;x<W;x+=16){
      pxFill((x+shift)%W, 120, 1, 60, "rgba(178,91,255,.06)");
    }
  }

  // Simple pixel sprites using rectangles
  function drawCowboy(t){
    const c = state.cowboy;
    const fall = c.fall; // 0..1
    const y = c.y + fall*28;
    const x = c.x;

    // shadow
    pxFill(x-10, 126, 20, 3, "rgba(0,0,0,.45)");

    // body palette
    const hat = "#caa06a";
    const coat = "#7dff9c";
    const pants = "#1b1f3c";
    const skin = "#ffccaa";

    const wob = Math.sin(t*0.006)*1;

    // falling tilt illusion: offset a bit
    const ox = fall*10;

    // hat
    pxFill(x-10+ox, y-18+wob, 22, 4, hat);
    pxFill(x-4+ox,  y-24+wob, 10, 6, hat);
    // head
    pxFill(x-3+ox, y-18+wob, 8, 7, skin);
    // coat
    pxFill(x-7+ox, y-10+wob, 14, 14, coat);
    // arm + gun
    if(c.pose==="shoot"){
      pxFill(x+6+ox, y-6+wob, 8, 3, coat);
      pxFill(x+14+ox, y-5+wob, 5, 2, "#d7dbe8"); // gun
      // muzzle flash is handled elsewhere
    }else{
      pxFill(x+4+ox, y-6+wob, 6, 3, coat);
      pxFill(x+10+ox, y-5+wob, 4, 2, "#d7dbe8");
    }
    // pants
    pxFill(x-6+ox, y+4+wob, 12, 10, pants);
    // boots
    pxFill(x-7+ox, y+14+wob, 6, 3, "#0b1020");
    pxFill(x+1+ox, y+14+wob, 6, 3, "#0b1020");

    // hit indicator
    if(c.hit){
      pxFill(x-12, y-26, 2, 2, "rgba(255,107,138,.9)");
      pxFill(x+12, y-20, 2, 2, "rgba(255,107,138,.9)");
    }
  }

  function drawRobot(t){
    const r = state.robot;
    const fall = r.fall;
    const y = r.y + fall*28;
    const x = r.x;

    // shadow
    pxFill(x-12, 126, 24, 3, "rgba(0,0,0,.45)");

    const metal = "#c7cfe4";
    const glow = 0.55 + 0.35*Math.sin(t*0.008);
    const eye = `rgba(36,246,255,${0.55+glow*0.25})`;
    const core = `rgba(178,91,255,${0.45+glow*0.25})`;

    const wob = Math.sin(t*0.006+1.1)*1;

    const ox = -fall*10;

    // head
    pxFill(x-8+ox, y-24+wob, 16, 12, metal);
    // eyes
    pxFill(x-5+ox, y-20+wob, 4, 2, eye);
    pxFill(x+1+ox, y-20+wob, 4, 2, eye);
    // antenna
    pxFill(x-1+ox, y-30+wob, 2, 6, metal);
    pxFill(x-2+ox, y-32+wob, 4, 2, eye);

    // torso
    pxFill(x-10+ox, y-12+wob, 20, 18, metal);
    // core
    pxFill(x-3+ox, y-6+wob, 6, 6, core);

    // arm + blaster
    if(r.pose==="shoot"){
      pxFill(x-18+ox, y-8+wob, 10, 3, metal);
      pxFill(x-24+ox, y-7+wob, 6, 2, eye); // blaster glow
    }else{
      pxFill(x-16+ox, y-8+wob, 8, 3, metal);
      pxFill(x-20+ox, y-7+wob, 4, 2, eye);
    }

    // legs
    pxFill(x-8+ox, y+6+wob, 6, 12, "#8a95b6");
    pxFill(x+2+ox, y+6+wob, 6, 12, "#8a95b6");

    // hit sparks
    if(r.hit){
      pxFill(x-12, y-28, 2, 2, "rgba(255,210,138,.95)");
      pxFill(x+12, y-22, 2, 2, "rgba(255,210,138,.95)");
    }
  }

  function drawHUDText(){
    // Top center banner in pixel style
    const msg = state.message;
    const sub = state.sub;

    // banner box
    pxFill(40, 10, 240, 28, "rgba(0,0,0,.55)");
    pxFill(40, 10, 240, 1, "rgba(36,246,255,.35)");
    pxFill(40, 37, 240, 1, "rgba(178,91,255,.28)");

    pxText(msg, 52, 28, "#eaf2ff");
    ctx.font = "10px ui-monospace, Menlo, Consolas, monospace";
    ctx.fillStyle = "rgba(245,250,255,.78)";
    ctx.fillText(sub, 52, 36);
  }

  function addSparks(x,y,count=10){
    for(let i=0;i<count;i++){
      state.sparks.push({
        x, y,
        vx: (Math.random()*2-1)*1.4,
        vy: (Math.random()*2-1)*1.2,
        life: 18 + Math.random()*10
      });
    }
  }

  function drawSparks(){
    for(const s of state.sparks){
      pxFill(s.x, s.y, 1, 1, "rgba(255,210,138,.95)");
      pxFill(s.x+1, s.y, 1, 1, "rgba(36,246,255,.55)");
      s.x += s.vx;
      s.y += s.vy;
      s.vy += 0.05;
      s.life -= 1;
    }
    state.sparks = state.sparks.filter(s => s.life > 0);
  }

  function spawnPixelConfetti(count=120){
    for(let i=0;i<count;i++){
      state.confetti.push({
        x: W/2, y: 40,
        vx: (Math.random()*2-1)*2.2,
        vy: (Math.random()*-1)*3.2 - 0.8,
        g: 0.08 + Math.random()*0.04,
        life: 80 + Math.random()*60,
        c: (i%3===0) ? "rgba(36,246,255,.9)" : (i%3===1) ? "rgba(178,91,255,.85)" : "rgba(125,255,156,.85)"
      });
    }
  }

  function drawConfetti(){
    for(const p of state.confetti){
      pxFill(p.x, p.y, 2, 2, p.c);
      p.x += p.vx;
      p.y += p.vy;
      p.vy += p.g;
      p.life -= 1;
    }
    state.confetti = state.confetti.filter(p => p.life > 0 && p.y < H+10);
  }

  function drawTracer(){
    if(!state.tracer) return;
    const tr = state.tracer;
    // draw dotted tracer
    const dx = tr.x2 - tr.x1;
    const dy = tr.y2 - tr.y1;
    const steps = 18;
    for(let i=0;i<steps;i++){
      const a = i/steps;
      const x = tr.x1 + dx*a;
      const y = tr.y1 + dy*a;
      if(i%2===0) pxFill(x, y, 2, 1, "rgba(36,246,255,.85)");
      else pxFill(x, y, 2, 1, "rgba(178,91,255,.65)");
    }
    tr.t -= 1;
    if(tr.t <= 0) state.tracer = null;
  }

  // ---------- Core Round Logic ----------
  function setMessage(msg, sub){
    state.message = msg;
    state.sub = sub;
  }

  function resetCharacters(){
    state.cowboy.pose = "idle"; state.cowboy.hit = false; state.cowboy.fall = 0;
    state.robot.pose = "idle";  state.robot.hit = false;  state.robot.fall = 0;
    state.tracer = null;
    state.sparks = [];
  }

  function resetRoundFlags(){
    state.inRound = true;
    state.waiting = true;
    state.fireShown = false;
    state.locked = false;
    state.fireTime = 0;
    state.aiReactMs = 0;
    resetCharacters();
  }

  function scheduleFire(){
    // suspense delay
    const delay = Math.floor(900 + Math.random() * 1600);

    state.fireTimer = setTimeout(() => {
      if(!state.inRound || state.locked) return;

      state.fireShown = true;
      state.waiting = false;
      state.fireTime = performance.now();

      setMessage("FIRE!", "SHOOT NOW (‚Üì / Space)");
      beep(980, 90, "square", 0.05);

      // sample AI reaction and schedule it
      state.aiReactMs = sampleAiReactionMs(difficultySel.value);
      state.aiTimer = setTimeout(() => {
        if(!state.inRound || state.locked) return;
        state.locked = true;
        // AI shoots cutscene
        doShoot("ai", null, Math.max(0, performance.now() - state.fireTime));
      }, state.aiReactMs);
    }, delay);
  }

  async function countdownThenWait(){
    // 3..2..1.. READY
    const steps = ["3","2","1","READY"];
    let idx = 0;

    return new Promise((resolve) => {
      const tick = () => {
        if(!state.inRound) return;
        const v = steps[idx];
        if(v === "READY"){
          setMessage("READY", "DON'T SHOOT EARLY");
          beep(620, 55, "sine", 0.04);
          resolve();
          return;
        }else{
          setMessage(v, "STEADY‚Ä¶");
          beep(440 + (3-idx)*90, 55, "sine", 0.04);
        }
        idx++;
        state.countdownTimer = setTimeout(tick, 520);
      };
      tick();
    });
  }

  function startRound(){
    clearTimers();
    resetRoundFlags();
    shootBtn.disabled = false;

    setMessage("ROUND " + state.round, "GET READY‚Ä¶");
    log(`Round ${state.round} started. Waiting for FIRE.`, "warn");
    beep(660, 60, "triangle", 0.04);

    countdownThenWait().then(() => {
      if(!state.inRound) return;
      setMessage("WAIT‚Ä¶", "HOLD IT‚Ä¶");
      scheduleFire();
    });
  }

  function startMatch(){
    ensureAudio();

    clearTimers();
    state.started = true;
    state.round = 1;
    state.scoreYou = 0;
    state.scoreAI = 0;
    state.youTimes = [];
    state.aiTimes = [];
    state.youFastest = null;

    logEl.innerHTML = "";
    log("Starting new match (Best-of-9).", "warn");
    log("Anti-cheat enabled: shooting early = FALSE START.", "warn");
    toast("Match started!");
    updateHUD();

    startRound();
  }

  function restartMatch(){
    toast("Restarting match.");
    log("Match restarted by user.", "warn");
    startMatch();
  }

  function endMatch(){
    state.started = false;
    state.inRound = false;
    shootBtn.disabled = true;
    clearTimers();

    const youWin = state.scoreYou > state.scoreAI;
    setMessage(youWin ? "MATCH WIN" : "MATCH LOST", `Final: You ${state.scoreYou} ‚Äî AI ${state.scoreAI}`);
    toast(youWin ? "Victory!" : "Defeat!");
    log(`MATCH OVER ‚Ä¢ You ${state.scoreYou} ‚Äî AI ${state.scoreAI}`, "warn");
    beep(youWin ? 880 : 220, 160, youWin ? "triangle" : "sawtooth", 0.06);
    spawnPixelConfetti(youWin ? 170 : 90);
  }

  function awardRound(winner, youMs, aiMs, reason){
    // record times
    if(typeof aiMs === "number" && Number.isFinite(aiMs)) state.aiTimes.push(aiMs);
    if(typeof youMs === "number" && Number.isFinite(youMs)){
      state.youTimes.push(youMs);
      state.youFastest = (state.youFastest === null) ? youMs : Math.min(state.youFastest, youMs);
    }

    if(winner === "you"){
      state.scoreYou++;
      toast("You win the round!");
      log(`Round ${state.round}: YOU WIN ‚Ä¢ you=${youMs===null?"‚Äî":Math.round(youMs)}ms, ai=${Math.round(aiMs)}ms ‚Ä¢ ${reason}`, "good");
      beep(880, 90, "triangle", 0.06);
    }else{
      state.scoreAI++;
      toast("AI wins the round.");
      log(`Round ${state.round}: AI WINS ‚Ä¢ you=${youMs===null?"‚Äî":Math.round(youMs)}ms, ai=${Math.round(aiMs)}ms ‚Ä¢ ${reason}`, "bad");
      beep(220, 120, "sawtooth", 0.05);
    }

    updateHUD();

    const roundsPlayed = state.scoreYou + state.scoreAI;
    const remaining = state.maxRounds - roundsPlayed;
    const youLead = state.scoreYou - state.scoreAI;
    const aiLead = state.scoreAI - state.scoreYou;
    const youClinched = youLead > remaining;
    const aiClinched = aiLead > remaining;

    if(roundsPlayed >= state.maxRounds || youClinched || aiClinched){
      endMatch();
      return;
    }

    state.round = roundsPlayed + 1;
    updateHUD();

    // short delay then next round
    setTimeout(() => {
      if(state.started) startRound();
    }, 1100);
  }

  // ---------- Cutscene: shooting ----------
  function doShoot(who, youMs, aiMs){
    // who: "you" or "ai"
    state.inRound = false;
    shootBtn.disabled = true;
    clearTimers();

    // set poses
    state.cowboy.pose = (who === "you") ? "shoot" : "idle";
    state.robot.pose  = (who === "ai")  ? "shoot" : "idle";

    // tracer + hit + fall timeline
    const cowboyMuzzle = { x: state.cowboy.x + 18, y: state.cowboy.y - 6 };
    const robotMuzzle  = { x: state.robot.x - 22,  y: state.robot.y - 7 };
    const robotHit     = { x: state.robot.x - 6,   y: state.robot.y - 16 };
    const cowboyHit    = { x: state.cowboy.x + 6,  y: state.cowboy.y - 14 };

    // Determine winner based on who fired first
    if(who === "you"){
      // you shoot robot
      setMessage("BANG!", `You: ${Math.round(youMs)}ms ‚Ä¢ AI: ${Math.round(aiMs)}ms`);
      state.tracer = { x1: cowboyMuzzle.x, y1: cowboyMuzzle.y, x2: robotHit.x, y2: robotHit.y, t: 10 };
      addSparks(robotHit.x, robotHit.y, 18);
      state.robot.hit = true;

      // robot falls
      setTimeout(() => { state.robot.fall = 0.35; }, 120);
      setTimeout(() => { state.robot.fall = 0.75; }, 260);
      setTimeout(() => { state.robot.fall = 1.00; }, 430);

      // celebrate
      setTimeout(() => { spawnPixelConfetti(110); }, 520);

      // award after animation
      setTimeout(() => {
        awardRound("you", youMs, aiMs, "Clean draw.");
        // reset poses next round starts
      }, 820);

    } else {
      // ai shoots cowboy
      setMessage("ZAP!", `AI: ${Math.round(aiMs)}ms`);
      state.tracer = { x1: robotMuzzle.x, y1: robotMuzzle.y, x2: cowboyHit.x, y2: cowboyHit.y, t: 10 };
      addSparks(cowboyHit.x, cowboyHit.y, 18);
      state.cowboy.hit = true;

      setTimeout(() => { state.cowboy.fall = 0.35; }, 120);
      setTimeout(() => { state.cowboy.fall = 0.75; }, 260);
      setTimeout(() => { state.cowboy.fall = 1.00; }, 430);

      setTimeout(() => {
        awardRound("ai", youMs, aiMs, (youMs===null) ? "False start." : "AI fired first.");
      }, 820);
    }
  }

  // Input handling (anti-cheat + double input)
  function handleShootInput(source){
    if(!state.started){
      toast("Press Start Match first.");
      beep(260, 60, "sine", 0.03);
      r
