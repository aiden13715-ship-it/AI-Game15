<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NEON QUICKDRAW: HUMAN VS AI</title>
  <style>
    :root{
      --bg0:#030513;
      --bg1:#070a20;
      --panel: rgba(8, 12, 34, .62);
      --panel2: rgba(5, 8, 26, .55);
      --line: rgba(255,255,255,.12);
      --txt: rgba(241,246,255,.95);
      --muted: rgba(241,246,255,.72);

      --cyan:#24f6ff;
      --mag:#b25bff;
      --lime:#7dff9c;
      --amber:#ffd28a;
      --red:#ff6b8a;

      --r: 20px;
      --shadow: 0 22px 70px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--txt);
      background:
        radial-gradient(900px 520px at 18% 18%, rgba(36,246,255,.14), transparent 60%),
        radial-gradient(900px 520px at 82% 12%, rgba(178,91,255,.12), transparent 60%),
        radial-gradient(900px 560px at 55% 88%, rgba(125,255,156,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Animated aurora */
    .aurora{
      position: fixed; inset:-60px;
      z-index:-4;
      background:
        radial-gradient(720px 280px at 22% 28%, rgba(36,246,255,.22), transparent 60%),
        radial-gradient(680px 260px at 78% 18%, rgba(178,91,255,.18), transparent 60%),
        radial-gradient(680px 260px at 55% 84%, rgba(125,255,156,.12), transparent 60%);
      filter: blur(16px);
      opacity:.9;
      animation: drift 10.5s ease-in-out infinite alternate;
    }
    @keyframes drift{
      0%{ transform: translate3d(-14px,-10px,0) scale(1); }
      100%{ transform: translate3d(14px,12px,0) scale(1.03); }
    }

    /* Moving grid overlay */
    .bgGrid{
      position: fixed; inset:0;
      z-index:-3;
      opacity:.22;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.09) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.07) 1px, transparent 1px);
      background-size: 56px 56px;
      mask-image: radial-gradient(circle at 50% 30%, rgba(0,0,0,1), rgba(0,0,0,.0) 70%);
      animation: gridMove 12s linear infinite;
    }
    @keyframes gridMove{
      from{ background-position: 0 0, 0 0; }
      to{ background-position: 0 170px, 170px 0; }
    }

    /* Scanlines */
    .scanlines{
      position: fixed; inset:0;
      z-index:-2;
      pointer-events:none;
      background: repeating-linear-gradient(
        to bottom,
        rgba(0,0,0,0) 0px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,.12) 4px
      );
      mix-blend-mode: overlay;
      opacity:.40;
    }

    /* Confetti layer */
    canvas#fx{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 60;
    }

    header{
      position: sticky;
      top:0;
      z-index: 10;
      background: rgba(6,10,34,.55);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding: 18px 16px;
      animation: dropIn .55s ease-out both;
    }
    @keyframes dropIn{
      from{ opacity:0; transform: translateY(-14px); }
      to{ opacity:1; transform: translateY(0); }
    }
    .wrap{ max-width: 1060px; margin:0 auto; }
    .titleRow{
      display:flex;
      gap: 14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size: 20px;
      letter-spacing:.4px;
      text-transform: uppercase;
    }
    .subtitle{
      margin-top:6px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    /* Glitch text effect */
    .glitch{
      position: relative;
      display: inline-block;
      text-shadow:
        0 0 14px rgba(36,246,255,.30),
        0 0 18px rgba(178,91,255,.22);
    }
    .glitch::before,
    .glitch::after{
      content: attr(data-text);
      position:absolute;
      left:0; top:0;
      opacity:.45;
      clip-path: inset(0 0 0 0);
      pointer-events:none;
    }
    .glitch::before{
      transform: translate(1px, -1px);
      color: rgba(36,246,255,.95);
      animation: glitchA 2.6s infinite linear alternate-reverse;
    }
    .glitch::after{
      transform: translate(-1px, 1px);
      color: rgba(178,91,255,.95);
      animation: glitchB 2.3s infinite linear alternate-reverse;
    }
    @keyframes glitchA{
      0%{ clip-path: inset(0 0 86% 0); }
      20%{ clip-path: inset(10% 0 58% 0); }
      40%{ clip-path: inset(44% 0 30% 0); }
      60%{ clip-path: inset(70% 0 10% 0); }
      80%{ clip-path: inset(16% 0 66% 0); }
      100%{ clip-path: inset(0 0 88% 0); }
    }
    @keyframes glitchB{
      0%{ clip-path: inset(82% 0 0 0); }
      25%{ clip-path: inset(55% 0 18% 0); }
      50%{ clip-path: inset(26% 0 46% 0); }
      75%{ clip-path: inset(10% 0 74% 0); }
      100%{ clip-path: inset(86% 0 0 0); }
    }

    main{
      max-width: 1060px;
      margin:0 auto;
      padding: 16px;
      display:grid;
      gap: 14px;
    }
    .grid2{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 920px){
      .grid2{ grid-template-columns: 1.25fr .75fr; }
    }

    .card{
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--r);
      padding: 16px;
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
      animation: cardIn .65s ease-out both;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(520px 160px at 20% 10%, rgba(36,246,255,.18), transparent 60%),
        radial-gradient(520px 160px at 80% 0%, rgba(178,91,255,.14), transparent 60%),
        radial-gradient(620px 160px at 50% 100%, rgba(125,255,156,.10), transparent 60%);
      opacity:.85;
      filter: blur(10px);
      pointer-events:none;
    }
    .card > *{ position: relative; }
    @keyframes cardIn{
      from{ opacity:0; transform: translateY(14px) scale(.985); }
      to{ opacity:1; transform: translateY(0) scale(1); }
    }

    .hud{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 0 0 1px rgba(36,246,255,.05) inset;
    }
    .pill strong{ font-weight: 900; letter-spacing:.2px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex:1; min-width: 160px; }

    label{ display:block; font-size:12px; color: var(--muted); margin-bottom: 6px; }

    select, button, input[type="checkbox"]{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(5, 8, 28, .68);
      color: var(--txt);
      outline: none;
    }
    select{
      width:100%;
      padding: 12px 12px;
    }
    select:focus{
      border-color: rgba(36,246,255,.55);
      box-shadow: 0 0 0 3px rgba(36,246,255,.10);
    }

    button{
      width:100%;
      padding: 12px 12px;
      cursor:pointer;
      font-weight: 950;
      letter-spacing:.35px;
      text-transform: uppercase;
      background: linear-gradient(135deg, rgba(36,246,255,.55), rgba(178,91,255,.50));
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
      position: relative;
      overflow:hidden;
      transition: transform .12s ease, filter .18s ease;
    }
    button::after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(240px 70px at var(--x,20%) var(--y,30%), rgba(255,255,255,.40), transparent 62%);
      opacity:0;
      transition: opacity .18s ease;
      pointer-events:none;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.08); }
    button:hover::after{ opacity:.60; }
    button:active{ transform: translateY(0) scale(.99); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .btnDanger{
      background: linear-gradient(135deg, rgba(255,107,138,.60), rgba(178,91,255,.48));
    }
    .btnGhost{
      background: linear-gradient(135deg, rgba(36,246,255,.25), rgba(255,255,255,.08));
    }

    /* Arena */
    .arena{
      margin-top: 10px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      box-shadow: 0 0 0 1px rgba(36,246,255,.06) inset;
      overflow:hidden;
      position: relative;
    }
    .arena::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(90deg, transparent, rgba(36,246,255,.10), transparent);
      transform: translateX(-70%);
      animation: sweep 2.6s linear infinite;
      pointer-events:none;
      opacity:.9;
    }
    @keyframes sweep{
      from{ transform: translateX(-80%); }
      to{ transform: translateX(80%); }
    }
    .arenaInner{
      padding: 18px;
      display:grid;
      gap: 14px;
      justify-items:center;
      text-align:center;
    }

    .signal{
      width: min(680px, 100%);
      border-radius: 20px;
      padding: 18px 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(6,10,34,.60);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      position: relative;
      overflow:hidden;
    }
    .signal::after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(480px 120px at 50% 10%, rgba(255,255,255,.14), transparent 60%);
      opacity:.75;
      pointer-events:none;
    }
    .signal > *{ position: relative; }

    .bigSignal{
      font-size: 38px;
      font-weight: 1000;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin: 0;
    }
    .hint{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .pulseRing{
      width: 120px; height: 120px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: radial-gradient(circle at 50% 40%, rgba(36,246,255,.22), rgba(178,91,255,.10), transparent 70%);
      box-shadow: 0 0 30px rgba(36,246,255,.18);
      position: relative;
      animation: ring 1.35s ease-in-out infinite;
    }
    .pulseRing::before{
      content:"";
      position:absolute; inset:-10px;
      border-radius:999px;
      border: 1px solid rgba(36,246,255,.18);
      filter: blur(.2px);
      animation: ring2 1.35s ease-in-out infinite;
    }
    @keyframes ring{
      0%,100%{ transform: scale(1); opacity:.85; }
      50%{ transform: scale(1.06); opacity:1; }
    }
    @keyframes ring2{
      0%,100%{ transform: scale(1); opacity:.35; }
      50%{ transform: scale(1.12); opacity:.55; }
    }

    .stats{
      display:grid;
      gap: 10px;
      margin-top: 10px;
    }
    .statBox{
      border-radius: 18px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }
    .statLabel{ font-size:12px; color: var(--muted); }
    .statValue{ font-size: 18px; font-weight: 950; margin-top: 4px; }

    /* Log */
    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      line-height: 1.45;
      max-height: 290px;
      overflow:auto;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }
    .good{ color: var(--lime); }
    .bad{ color: var(--red); }
    .warn{ color: var(--amber); }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      top: 78px;
      transform: translateX(-50%);
      z-index: 55;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(6,10,34,.65);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      font-size: 13px;
      opacity: 0;
      pointer-events:none;
    }
    .toast.show{ animation: toastPop 1.35s ease-out both; }
    @keyframes toastPop{
      0%{ opacity:0; transform: translateX(-50%) translateY(-6px) scale(.985); }
      16%{ opacity:1; transform: translateX(-50%) translateY(0) scale(1); }
      82%{ opacity:1; }
      100%{ opacity:0; transform: translateX(-50%) translateY(-7px) scale(.99); }
    }

    /* Intro overlay */
    .intro{
      position: fixed; inset:0;
      z-index: 90;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.50);
      backdrop-filter: blur(12px);
    }
    .introCard{
      width: min(980px, 100%);
      border-radius: 24px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(6,10,34,.68);
      box-shadow: 0 28px 80px rgba(0,0,0,.55);
      position: relative;
      overflow:hidden;
      animation: introIn .65s ease-out both;
    }
    .introCard::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(520px 180px at 20% 10%, rgba(36,246,255,.22), transparent 60%),
        radial-gradient(520px 180px at 85% 18%, rgba(178,91,255,.18), transparent 60%),
        radial-gradient(520px 180px at 55% 90%, rgba(125,255,156,.12), transparent 60%);
      filter: blur(10px);
      opacity: .95;
    }
    .introCard > *{ position: relative; }
    @keyframes introIn{
      from{ opacity:0; transform: translateY(18px) scale(.98); }
      to{ opacity:1; transform: translateY(0) scale(1); }
    }
    .introTitle{
      font-size: 22px;
      font-weight: 1000;
      margin: 0 0 6px 0;
      letter-spacing:.6px;
      text-transform: uppercase;
    }
    .introText{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.4;
    }
    .chips{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 14px;
    }
    .chip{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 12px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      margin: 0 2px;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
      .aurora,.bgGrid{ display:none; }
    }
  </style>
</head>

<body>
  <div class="aurora"></div>
  <div class="bgGrid"></div>
  <div class="scanlines"></div>
  <div class="toast" id="toast"></div>
  <canvas id="fx"></canvas>

  <div class="intro" id="intro">
    <div class="introCard">
      <div class="row" style="align-items:flex-start;">
        <div style="flex: 1.3; min-width: 260px;">
          <div class="introTitle glitch" data-text="NEON QUICKDRAW: HUMAN VS AI">NEON QUICKDRAW: HUMAN VS AI</div>
          <p class="introText">
            Wait for the signal. When <b>FIRE!</b> appears, react as fast as you can by clicking
            <b>DRAW</b> or pressing <span class="kbd">Space</span>.
            Click/press early and you get a <b>FALSE START</b> (automatic round loss).
          </p>
          <div class="chips">
            <span class="chip">‚ö° Futuristic neon UI</span>
            <span class="chip">üéÆ Best-of-9</span>
            <span class="chip">üß† AI difficulty</span>
            <span class="chip">üõ°Ô∏è Anti-cheat + error handling</span>
            <span class="chip">‚ú® Confetti + neon burst</span>
          </div>
          <div class="row" style="margin-top:14px;">
            <button id="enterBtn" style="max-width: 280px;">Boot Arena</button>
            <div style="color:var(--muted); font-size:12px; align-self:center;">
              Tip: Press <span class="kbd">Space</span> to draw.
            </div>
          </div>
        </div>

        <div style="flex:.7; min-width: 240px;">
          <div class="pill" style="justify-content:center; margin-bottom:10px;">
            <strong>ATTRACTION MODE</strong> <span style="opacity:.75;">(animated)</span>
          </div>
          <div class="pulseRing" aria-hidden="true"></div>
          <div style="height:10px;"></div>
          <div class="pill"><span style="width:10px;height:10px;border-radius:999px;background:var(--cyan);box-shadow:0 0 16px rgba(36,246,255,.65);display:inline-block;"></span> System online ‚Ä¢ Waiting for duel</div>
        </div>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap">
      <div class="titleRow">
        <div>
          <h1 class="glitch" data-text="NEON QUICKDRAW">NEON QUICKDRAW</h1>
          <div class="subtitle">Competitive 1v1 reaction duel vs AI ‚Ä¢ Click DRAW or press Space ‚Ä¢ False starts lose rounds</div>
          <div class="hud" id="hud"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="grid2">
    <section class="card">
      <div class="row">
        <div>
          <label for="difficulty">AI Difficulty</label>
          <select id="difficulty">
            <option value="easy">Easy (slow AI)</option>
            <option value="normal" selected>Normal</option>
            <option value="hard">Hard (fast AI)</option>
          </select>
        </div>
        <div>
          <label for="reducedMotion">Reduced Motion</label>
          <div class="pill" style="justify-content:space-between;">
            <span style="color:var(--muted); font-size:12px;">Toggle animations</span>
            <input id="reducedMotion" type="checkbox" />
          </div>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="startBtn">Start Match</button>
        </div>
      </div>

      <div class="arena" style="margin-top:14px;">
        <div class="arenaInner">
          <div class="signal" id="signalBox">
            <p class="bigSignal glitch" id="signal" data-text="READY">READY</p>
            <p class="hint" id="hintText">Press <span class="kbd">Space</span> or click <b>DRAW</b> when you see <b>FIRE!</b>.</p>
          </div>

          <div class="row" style="width:min(680px,100%);">
            <button id="drawBtn" class="btnDanger">DRAW</button>
            <button id="resetBtn" class="btnGhost">Restart Match</button>
          </div>

          <div class="hud" style="justify-content:center;">
            <span class="pill"><strong>Anti-cheat:</strong> early draw = FALSE START</span>
            <span class="pill"><strong>Input:</strong> click or Space (double inputs ignored)</span>
          </div>
        </div>
      </div>
    </section>

    <aside class="card">
      <div class="row" style="align-items:flex-start;">
        <div>
          <div class="pill"><strong>Score</strong> <span style="opacity:.75;">(Best-of-9)</span></div>
          <div class="stats">
            <div class="statBox">
              <div class="statLabel">You</div>
              <div class="statValue" id="scoreYou">0</div>
            </div>
            <div class="statBox">
              <div class="statLabel">AI</div>
              <div class="statValue" id="scoreAI">0</div>
            </div>
            <div class="statBox">
              <div class="statLabel">Round</div>
              <div class="statValue" id="roundNum">1 / 9</div>
            </div>
          </div>

          <div class="pill" style="margin-top:14px;"><strong>Stats</strong> <span style="opacity:.75;">(ms)</span></div>
          <div class="stats">
            <div class="statBox">
              <div class="statLabel">Your Avg Reaction</div>
              <div class="statValue" id="avgYou">‚Äî</div>
            </div>
            <div class="statBox">
              <div class="statLabel">Your Fastest</div>
              <div class="statValue" id="fastYou">‚Äî</div>
            </div>
            <div class="statBox">
              <div class="statLabel">AI Avg Reaction</div>
              <div class="statValue" id="avgAi">‚Äî</div>
            </div>
          </div>
        </div>
      </div>

      <div style="height:12px;"></div>

      <div class="pill"><strong>Training Log</strong> <span style="opacity:.75;">(debug + documentation)</span></div>
      <div class="log" id="log" style="margin-top:10px;"></div>

      <div style="height:12px;"></div>
      <div class="row">
        <button id="copyLogBtn">Copy Log</button>
        <button id="muteBtn" class="btnGhost">Sound: ON</button>
      </div>
    </aside>
  </main>

<script>
(() => {
  // ---------- DOM ----------
  const $ = (id) => document.getElementById(id);
  const hudEl = $("hud");
  const toastEl = $("toast");
  const signalEl = $("signal");
  const hintEl = $("hintText");
  const drawBtn = $("drawBtn");
  const resetBtn = $("resetBtn");
  const startBtn = $("startBtn");
  const difficultySel = $("difficulty");
  const reducedMotionChk = $("reducedMotion");

  const scoreYouEl = $("scoreYou");
  const scoreAiEl = $("scoreAI");
  const roundNumEl = $("roundNum");
  const avgYouEl = $("avgYou");
  const fastYouEl = $("fastYou");
  const avgAiEl = $("avgAi");

  const logEl = $("log");
  const copyLogBtn = $("copyLogBtn");
  const muteBtn = $("muteBtn");

  // Button shimmer tracking (for hover glow)
  document.addEventListener("pointermove", (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;
    const r = btn.getBoundingClientRect();
    const x = ((e.clientX - r.left) / r.width) * 100;
    const y = ((e.clientY - r.top) / r.height) * 100;
    btn.style.setProperty("--x", x + "%");
    btn.style.setProperty("--y", y + "%");
  });

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.remove("show");
    void toastEl.offsetWidth;
    toastEl.classList.add("show");
  }

  function log(msg, cls=""){
    const line = document.createElement("div");
    if(cls) line.className = cls;
    const t = new Date().toLocaleTimeString();
    line.textContent = `[${t}] ${msg}`;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }

  // ---------- Audio (Web Audio beeps, no external files) ----------
  let audioCtx = null;
  let muted = false;

  function ensureAudio(){
    if (audioCtx) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return;
    audioCtx = new AC();
  }

  function beep(freq=660, durMs=70, type="sine", gain=0.06){
    if (muted) return;
    try{
      ensureAudio();
      if(!audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g);
      g.connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime + durMs/1000);
    }catch{ /* ignore audio errors */ }
  }

  muteBtn.addEventListener("click", () => {
    muted = !muted;
    muteBtn.textContent = muted ? "Sound: OFF" : "Sound: ON";
    toast(muted ? "Sound muted." : "Sound enabled.");
  });

  // ---------- Reduced motion toggle ----------
  function applyReducedMotion(on){
    // quick-and-safe: add inline style disabling animations
    document.documentElement.style.scrollBehavior = on ? "auto" : "smooth";
    const sheets = document.styleSheets;
    // We won't mutate stylesheets (can throw security errors).
    // Instead, set a flag and avoid heavy FX updates (confetti/bursts) when reduced.
    state.reducedMotion = on;
    toast(on ? "Reduced motion ON" : "Reduced motion OFF");
  }
  reducedMotionChk.addEventListener("change", () => applyReducedMotion(reducedMotionChk.checked));

  // ---------- Confetti + Neon Burst FX ----------
  const canvas = $("fx");
  const ctx = canvas.getContext("2d");
  function resizeCanvas(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  let particles = [];
  function spawnBurst(x, y, count=90){
    if(state.reducedMotion) return;
    for(let i=0;i<count;i++){
      particles.push({
        x, y,
        vx: (Math.random()*2-1) * (4 + Math.random()*4),
        vy: (Math.random()*2-1) * (4 + Math.random()*4),
        g: 0.10 + Math.random()*0.12,
        life: 70 + Math.random()*40,
        a: 1,
        r: 2 + Math.random()*3,
        rot: Math.random()*Math.PI*2,
        spin: (Math.random()*2-1)*0.25
      });
    }
  }

  function tickFx(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    particles = particles.filter(p => p.life > 0 && p.a > 0);
    for(const p of particles){
      p.life -= 1;
      p.vy += p.g;
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.spin;
      p.a = Math.max(0, p.a - 0.015);

      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);

      // Neon-ish rectangles (no fixed palette needed, but use subtle glow)
      ctx.fillStyle = "rgba(36,246,255,.75)";
      ctx.fillRect(-p.r, -p.r, p.r*2.2, p.r*1.2);
      ctx.fillStyle = "rgba(178,91,255,.55)";
      ctx.fillRect(-p.r*0.7, -p.r*0.7, p.r*1.4, p.r*0.9);

      ctx.restore();
    }
    requestAnimationFrame(tickFx);
  }
  tickFx();

  function centerBurst(){
    spawnBurst(window.innerWidth * 0.5, 140, 130);
  }

  // ---------- Game State ----------
  const state = {
    started: false,
    inRound: false,
    waitingForFire: false,
    fireShown: false,
    locked: false,          // prevents double input
    reducedMotion: false,

    round: 1,
    maxRounds: 9,

    scoreYou: 0,
    scoreAI: 0,

    fireTime: 0,            // performance.now() when FIRE displayed
    aiReactMs: 0,           // sampled AI reaction time this round
    aiTimer: null,          // setTimeout handle
    fireTimer: null,        // setTimeout handle
    countdownTimer: null,   // setTimeout handle

    youTimes: [],           // valid reaction times (ms)
    aiTimes: [],            // AI reaction times for rounds AI "wins" or "plays"? We'll record each round.
    youFastest: null,
  };

  function setSignal(text, sub, glitch=true){
    signalEl.textContent = text;
    signalEl.setAttribute("data-text", text);
    signalEl.classList.toggle("glitch", !!glitch);
    hintEl.innerHTML = sub;
  }

  function updateHUD(){
    hudEl.innerHTML = "";
    const pills = [
      `Round: ${state.round}/${state.maxRounds}`,
      `You: ${state.scoreYou}`,
      `AI: ${state.scoreAI}`,
      `Difficulty: ${difficultySel.value.toUpperCase()}`,
      `Input: Click / Space`
    ];
    for(const t of pills){
      const s = document.createElement("span");
      s.className = "pill";
      s.textContent = t;
      hudEl.appendChild(s);
    }

    scoreYouEl.textContent = String(state.scoreYou);
    scoreAiEl.textContent = String(state.scoreAI);
    roundNumEl.textContent = `${state.round} / ${state.maxRounds}`;

    // stats
    const avg = (arr) => arr.length ? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : null;
    const youAvg = avg(state.youTimes);
    const aiAvg = avg(state.aiTimes);

    avgYouEl.textContent = youAvg === null ? "‚Äî" : `${youAvg}`;
    avgAiEl.textContent = aiAvg === null ? "‚Äî" : `${aiAvg}`;
    fastYouEl.textContent = state.youFastest === null ? "‚Äî" : `${Math.round(state.youFastest)}`;
  }

  function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

  // AI reaction time distribution (ms)
  // We use a skewed normal-ish (sum of uniforms) to feel human-like.
  function sampleAiReactionMs(diff){
    // base means roughly match your class demo: easy slower, hard faster
    let base, spread;
    if(diff === "easy"){ base = 360; spread = 140; }
    else if(diff === "hard"){ base = 210; spread = 90; }
    else { base = 280; spread = 110; }

    // sum of 6 uniforms -> approx normal around 3
    let u = 0;
    for(let i=0;i<6;i++) u += Math.random();
    u = (u/6) - 0.5; // -0.5..0.5-ish
    let ms = base + u * spread;

    // add a tiny chance of "super reaction" or "hesitation" to make it interesting
    if(Math.random() < 0.06) ms -= 70;   // lucky
    if(Math.random() < 0.06) ms += 90;   // hesitation

    ms = clamp(ms, diff === "hard" ? 140 : 170, 650);
    return Math.round(ms);
  }

  function clearTimers(){
    if(state.aiTimer){ clearTimeout(state.aiTimer); state.aiTimer = null; }
    if(state.fireTimer){ clearTimeout(state.fireTimer); state.fireTimer = null; }
    if(state.countdownTimer){ clearTimeout(state.countdownTimer); state.countdownTimer = null; }
  }

  function disableRoundInputs(disabled){
    drawBtn.disabled = disabled;
  }

  function resetRoundFlags(){
    state.inRound = true;
    state.waitingForFire = true;
    state.fireShown = false;
    state.locked = false;
    state.fireTime = 0;
    state.aiReactMs = 0;
  }

  function matchOver(){
    state.started = false;
    state.inRound = false;
    clearTimers();
    disableRoundInputs(true);

    const youWin = state.scoreYou > state.scoreAI;
    const title = youWin ? "YOU WIN THE MATCH" : "AI WINS THE MATCH";
    setSignal(title, `Final: <b>You ${state.scoreYou}</b> ‚Äî <b>AI ${state.scoreAI}</b>. Press <b>Restart Match</b> to play again.`, true);
    toast(youWin ? "Victory!" : "Defeat!");

    // big FX
    beep(880, 90, "triangle", 0.06);
    beep(660, 120, "sine", 0.05);
    centerBurst();
    spawnBurst(window.innerWidth*0.5, window.innerHeight*0.35, 180);
    log(`MATCH OVER ‚Ä¢ You ${state.scoreYou} ‚Äî AI ${state.scoreAI}`, "warn");
  }

  function awardRound(winner, reason, youMs=null, aiMs=null){
    // winner: "you" | "ai"
    state.inRound = false;
    clearTimers();
    disableRoundInputs(true);

    if(winner === "you"){
      state.scoreYou += 1;
      if(typeof youMs === "number"){
        state.youTimes.push(youMs);
        state.youFastest = (state.youFastest === null) ? youMs : Math.min(state.youFastest, youMs);
      }
      if(typeof aiMs === "number") state.aiTimes.push(aiMs);

      setSignal("ROUND WIN", `You drew in <b>${Math.round(youMs)}ms</b>. AI: <b>${Math.round(aiMs)}ms</b>. ${reason}`, true);
      toast("You win the round!");
      log(`Round ${state.round}: YOU WIN ‚Ä¢ you=${Math.round(youMs)}ms, ai=${Math.round(aiMs)}ms ‚Ä¢ ${reason}`, "good");
      beep(880, 80, "triangle", 0.06);
      spawnBurst(window.innerWidth*0.5, 160, 120);
    }else{
      state.scoreAI += 1;
      if(typeof aiMs === "number") state.aiTimes.push(aiMs);

      // false start => youMs null
      const extra = (typeof youMs === "number") ? `You: <b>${Math.round(youMs)}ms</b>. ` : "";
      setSignal("ROUND LOST", `${extra}AI: <b>${Math.round(aiMs)}ms</b>. ${reason}`, true);
      toast("AI wins the round.");
      log(`Round ${state.round}: AI WINS ‚Ä¢ you=${youMs===null?"‚Äî":Math.round(youMs)+"ms"}, ai=${Math.round(aiMs)}ms ‚Ä¢ ${reason}`, "bad");
      beep(220, 120, "sawtooth", 0.05);
      spawnBurst(window.innerWidth*0.5, 160, 80);
    }

    updateHUD();

    // advance round or end match
    const roundsPlayed = state.scoreYou + state.scoreAI;
    const max = state.maxRounds;

    // If a player is unreachable by remaining rounds, end early (best-of-9 logic)
    const remaining = max - roundsPlayed;
    const youLead = state.scoreYou - state.scoreAI;
    const aiLead = state.scoreAI - state.scoreYou;
    const youClinched = youLead > remaining;
    const aiClinched = aiLead > remaining;

    if(roundsPlayed >= max || youClinched || aiClinched){
      matchOver();
      return;
    }

    // Next round
    state.round = roundsPlayed + 1;
    updateHUD();

    // quick auto-continue after a moment
    state.countdownTimer = setTimeout(() => startRound(), 900);
  }

  function showCountdown(n){
    if(state.reducedMotion){
      setSignal("GET READY", `Round ${state.round} ‚Ä¢ Waiting for signal‚Ä¶`, true);
      return Promise.resolve();
    }
    return new Promise((resolve) => {
      const steps = [3,2,1];
      let idx = 0;

      const tick = () => {
        const v = steps[idx];
        setSignal(String(v), `Round ${state.round} ‚Ä¢ Don‚Äôt draw early.`, true);
        beep(440 + v*80, 60, "sine", 0.05);
        idx++;
        if(idx >= steps.length){
          setSignal("READY", `Round ${state.round} ‚Ä¢ Wait for <b>FIRE!</b> then draw.`, true);
          resolve();
          return;
        }
        state.countdownTimer = setTimeout(tick, 520);
      };

      tick();
    });
  }

  function scheduleFire(){
    // random delay (ms) until FIRE appears
    // keep it suspenseful
    const min = 900;
    const max = 2400;
    const delay = Math.floor(min + Math.random() * (max - min + 1));

    state.fireTimer = setTimeout(() => {
      if(!state.inRound) return;
      state.fireShown = true;
      state.waitingForFire = false;
      state.fireTime = performance.now();

      // show FIRE
      setSignal("FIRE!", `CLICK <b>DRAW</b> or press <span class="kbd">Space</span> NOW!`, true);
      beep(980, 90, "square", 0.05);
      spawnBurst(window.innerWidth * 0.5, 160, 70);

      // schedule AI draw
      const diff = difficultySel.value;
      state.aiReactMs = sampleAiReactionMs(diff);

      state.aiTimer = setTimeout(() => {
        if(!state.inRound || state.locked) return;
        // AI draws; if player hasn't drawn yet, AI wins
        state.locked = true;
        const aiMs = Math.max(0, performance.now() - state.fireTime); // defensive
        awardRound("ai", "AI fired first.", null, aiMs);
      }, state.aiReactMs);

    }, delay);
  }

  async function startRound(){
    clearTimers();
    resetRoundFlags();
    disableRoundInputs(false);

    // pre-signal display
    setSignal("READY", `Round ${state.round} ‚Ä¢ Wait‚Ä¶ don‚Äôt draw early.`, true);
    log(`Round ${state.round} started. Waiting for FIRE.`, "warn");

    await showCountdown();

    // now schedule fire
    scheduleFire();
  }

  function startMatch(){
    ensureAudio(); // initialize on user gesture for browsers that block auto audio
    clearTimers();

    state.started = true;
    state.round = 1;
    state.scoreYou = 0;
    state.scoreAI = 0;
    state.youTimes = [];
    state.aiTimes = [];
    state.youFastest = null;

    updateHUD();
    toast("Match started!");
    logEl.innerHTML = "";
    log("Starting new match (Best-of-9).", "warn");
    log("Anti-cheat enabled: early draw = FALSE START.", "warn");
    beep(660, 70, "triangle", 0.05);

    startRound();
  }

  function restartMatch(){
    toast("Restarting match.");
    log("Match restarted by user.", "warn");
    startMatch();
  }

  // Anti-cheat + input handling
  function handleDrawInput(source){
    // Error handling: ignore input if match not started
    if(!state.started){
      toast("Press Start Match first.");
      beep(260, 60, "sine", 0.03);
      return;
    }
    if(!state.inRound){
      // ignore spam/double clicks
      return;
    }
    if(state.locked){
      // double input prevention
      return;
    }

    // If FIRE hasn't shown yet => FALSE START (automatic loss)
    if(!state.fireShown){
      state.locked = true;
      clearTimers(); // cancel pending FIRE/AI
      disableRoundInputs(true);

      // AI "reaction" isn't relevant, but show a typical time for flavor
      const aiMs = sampleAiReactionMs(difficultySel.value);
      awardRound("ai", `FALSE START (${source}). You drew before FIRE.`, null, aiMs);
      return;
    }

    // Valid draw
    state.locked = true;

    // Compute reaction time safely
    const now = performance.now();
    let youMs = now - state.fireTime;

    // prevent negative times (defensive)
    if(!Number.isFinite(youMs) || youMs < 0) youMs = 0;

    // AI time for comparison: the sampled one, but we‚Äôll use actual elapsed too
    const aiActualMs = Math.max(0, now - state.fireTime);

    // Determine winner: compare player time vs AI sampled time
    // Use the sampled AI reaction as "AI fires at that time"
    const aiMs = state.aiReactMs;

    // If player is faster than AI sampled time => player wins
    if(youMs < aiMs){
      awardRound("you", `Clean draw (${source}).`, youMs, aiMs);
    }else if(youMs > aiMs){
      awardRound("ai", `AI edged you out (${source}).`, youMs, aiMs);
    }else{
      // tie-breaker: player wins ties (feels fair)
      awardRound("you", `Photo finish (${source}) ‚Äî tie goes to human.`, youMs, aiMs);
    }
  }

  // ---------- Events ----------
  $("enterBtn").addEventListener("click", () => {
    $("intro").style.display = "none";
    toast("Arena booted. Start a match!");
    beep(520, 60, "sine", 0.04);
  });

  startBtn.addEventListener("click", startMatch);
  resetBtn.addEventListener("click", restartMatch);

  drawBtn.addEventListener("click", () => handleDrawInput("click"));

  // Spacebar input (prevent scrolling)
  window.addEventListener("keydown", (e) => {
    if(e.code === "Space"){
      e.preventDefault();
      handleDrawInput("space");
    }
  }, { passive: false });

  // Copy log for documentation
  copyLogBtn.addEventListener("click", async () => {
    try{
      const text = Array.from(logEl.children).map(d => d.textContent).join("\n");
      await navigator.clipboard.writeText(text);
      toast("Log copied!");
      log("Log copied to clipboard.", "good");
      beep(740, 60, "sine", 0.04);
    }catch{
      toast("Clipboard blocked ‚Äî copy manually.");
      log("Clipboard blocked by browser settings.", "warn");
      beep(240, 60, "sine", 0.03);
    }
  });

  // Difficulty change: applies immediately for next rounds (safe)
  difficultySel.addEventListener("change", () => {
    toast(`Difficulty: ${difficultySel.value.toUpperCase()}`);
    log(`Difficulty set to ${difficultySel.value}.`, "warn");
    updateHUD();
  });

  // Reduced motion
  reducedMotionChk.addEventListener("change", () => applyReducedMotion(reducedMotionChk.checked));

  // Start with inputs disabled until match starts
  disableRoundInputs(true);
  updateHUD();
  setSignal("READY", `Press <b>Start Match</b>. Then wait for <b>FIRE!</b>.`, true);
  log("Boot screen ready. Click BOOT ARENA, then Start Match.", "warn");

  // Celebrate win with confetti burst already wired in matchOver()

})();
</script>
</body>
</html>


